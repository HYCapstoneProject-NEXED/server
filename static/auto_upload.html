<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“· ìë™ ê²°í•¨ ì´ë¯¸ì§€ ì—…ë¡œë“œ</title>
</head>
<body style="font-family: sans-serif; padding: 20px; text-align: center;">
  <h2>ğŸ“¸ ìë™ ì´¬ì˜ ì‹œìŠ¤í…œ</h2>
  <video id="cameraPreview" autoplay playsinline style="width: 100%; max-width: 400px; border: 1px solid #ccc;"></video>
  <canvas id="canvas" style="display: none;"></canvas>
  <p id="log" style="margin-top: 20px;">ğŸ¬ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´¬ì˜ì´ ì‹œì‘ë©ë‹ˆë‹¤</p>

  <button id="startButton" style="margin: 10px; padding: 10px;">â–¶ï¸ ì‹œì‘</button>
  <button id="toggleButton" style="margin: 10px; padding: 10px; display: none;">â¸ï¸ ì—…ë¡œë“œ ì¤‘ë‹¨</button>

  <script>
    const video = document.getElementById("cameraPreview");
    const canvas = document.getElementById("canvas");
    const log = document.getElementById("log");
    const toggleButton = document.getElementById("toggleButton");
    const startButton = document.getElementById("startButton");

    const cameraId = 6;
    const uploadUrl = "https://bea2-59-14-67-65.ngrok-free.app/static/auto_upload.html";

    let uploadInterval = null;
    let isUploading = true;

    // âœ… 1. ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°ë§Œ ë¨¼ì € ì‹œì‘
    async function initializeCameraPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        log.innerText = "âœ… ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° ì¤€ë¹„ ì™„ë£Œ. ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.";
        console.log("âœ… ì¹´ë©”ë¼ í”„ë¦¬ë·° ì—°ê²°ë¨");
      } catch (err) {
        log.innerText = "âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message;
        console.error("âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨", err);
      }
    }

    // âœ… 2. ì‹œì‘ ë²„íŠ¼ ëˆ„ë¥´ë©´ ìº¡ì²˜ ì‹œì‘
    function startAutoCapture() {
      const ctx = canvas.getContext("2d");

      uploadInterval = setInterval(async () => {
        if (!isUploading) return;

        const width = video.videoWidth;
        const height = video.videoHeight;

        if (width === 0 || height === 0) {
          console.warn("âš ï¸ ë¹„ë””ì˜¤ í¬ê¸° ì´ˆê¸°í™” ì „, ìº¡ì²˜ ìŠ¤í‚µ");
          return;
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(video, 0, 0, width, height);

        console.log("ğŸ“¸ í”„ë ˆì„ ìº¡ì²˜ë¨");

        canvas.toBlob(async (blob) => {
          console.log("ğŸ§© Blob ìƒì„±ë¨:", blob);

          const formData = new FormData();
          formData.append("file", blob, `capture_${Date.now()}.jpg`);
          formData.append("camera_id", cameraId);

          try {
            console.log("ğŸ“¡ ì—…ë¡œë“œ ì‹œì‘:", uploadUrl);

            const res = await fetch(uploadUrl, {
              method: "POST",
              body: formData,
              mode: "cors",
            });

            const responseText = await res.text();
            console.log("ğŸ“ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ:", res.status, responseText);

            if (!res.ok) {
              throw new Error(`HTTP ${res.status} - ${responseText}`);
            }

            const data = JSON.parse(responseText);
            log.innerText = `âœ… ì—…ë¡œë“œ ì„±ê³µ: ì´ë¯¸ì§€ ID ${data.image_id}`;
          } catch (err) {
            log.innerText = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}`;
            console.error("âŒ ì—…ë¡œë“œ ì—ëŸ¬:", err);
          }
        }, "image/jpeg");
      }, 3000);
    }

    // âœ… 3. ì¤‘ë‹¨/ì¬ê°œ ë²„íŠ¼ í† ê¸€
    toggleButton.addEventListener("click", () => {
      isUploading = !isUploading;
      toggleButton.innerText = isUploading ? "â¸ï¸ ì—…ë¡œë“œ ì¤‘ë‹¨" : "â–¶ï¸ ì—…ë¡œë“œ ì¬ê°œ";
      log.innerText = isUploading ? "âœ… ì—…ë¡œë“œ ì¬ê°œë¨" : "â›” ì—…ë¡œë“œ ì¤‘ë‹¨ë¨";
    });

    // âœ… 4. ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì´¬ì˜ ì‹œì‘
    startButton.addEventListener("click", () => {
      log.innerText = "ğŸ“¸ ìë™ ì´¬ì˜ ì‹œì‘ë¨ (3ì´ˆ ê°„ê²©)";
      startAutoCapture();
      startButton.style.display = "none";
      toggleButton.style.display = "inline-block";
    });

    // ì´ˆê¸° ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°ë§Œ ì‹¤í–‰
    initializeCameraPreview();
  </script>
</body>
</html>
